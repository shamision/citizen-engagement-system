
{% extends 'base.html' %}

{% block title %}Analytics - Citizen Engagement System{% endblock %}

{% block extra_css %}
<style>
    .card-stats {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
    }
    .card-stats:hover {
        transform: translateY(-5px);
    }
    .stats-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 24px;
    }
    .stats-value {
        font-size: 1.8rem;
        font-weight: 700;
    }
    .card-chart {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .chart-container {
        height: 300px;
    }
    .gauge-chart {
        position: relative;
        height: 150px;
    }
    .gauge-value {
        position: absolute;
        top: 65%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
    }
    .gauge-label {
        position: absolute;
        top: 85%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8rem;
        color: #6c757d;
    }
    .service-card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }
    .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    .service-icon {
        font-size: 2rem;
        color: #4e73df;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Analytics</h1>
        <div class="date">{{ current_date|date:"d F, Y" }}</div>
    </div>

    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats h-100 border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Total Complaints</h5>
                            <span class="stats-value text-primary">{{ total_complaints }}</span>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-primary text-white">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-2"><i class="fas fa-arrow-up"></i> 3.48%</span>
                        <span class="text-nowrap">Since last month</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats h-100 border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Resolution Rate</h5>
                            <span class="stats-value text-success">{{ resolution_rate }}%</span>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-success text-white">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-2"><i class="fas fa-arrow-up"></i> 5.28%</span>
                        <span class="text-nowrap">Since last month</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats h-100 border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Avg. Resolution Time</h5>
                            <span class="stats-value text-info">{{ avg_resolution_time }} days</span>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-info text-white">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-danger me-2"><i class="fas fa-arrow-down"></i> 1.10%</span>
                        <span class="text-nowrap">Since yesterday</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats h-100 border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Citizen Satisfaction</h5>
                            <span class="stats-value text-warning">{{ satisfaction_rate }}%</span>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-warning text-white">
                                <i class="fas fa-smile"></i>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-muted">
                        <span class="text-success me-2"><i class="fas fa-arrow-up"></i> 2.15%</span>
                        <span class="text-nowrap">Since last month</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card card-chart border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="font-weight-bold mb-0">Monthly Complaints</h6>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active">Monthly</button>
                        <button type="button" class="btn btn-sm btn-outline-primary">Quarterly</button>
                        <button type="button" class="btn btn-sm btn-outline-primary">Yearly</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyComplaintsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card card-chart border-0">
                <div class="card-header bg-white">
                    <h6 class="font-weight-bold mb-0">Complaints by Status</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-4">
            <div class="card card-chart border-0">
                <div class="card-header bg-white">

                    <h6 class="font-weight-bold mb-0">Most Used Service</h6>
                </div>
                <div class="card-body">
                    <div class="gauge-chart">
                        <canvas id="mostUsedServiceChart"></canvas>
                        <div class="gauge-value">78%</div>
                        <div class="gauge-label">Roads Department</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card card-chart border-0">
                <div class="card-header bg-white">
                    <h6 class="font-weight-bold mb-0">Least Used Service</h6>
                </div>
                <div class="card-body">
                    <div class="gauge-chart">
                        <canvas id="leastUsedServiceChart"></canvas>
                        <div class="gauge-value">12%</div>
                        <div class="gauge-label">Health Department</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card card-chart border-0">
                <div class="card-header bg-white">
                    <h6 class="font-weight-bold mb-0">Consumed Services</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mt-3">
                        <h2 class="stats-value">3,500,000</h2>
                        <p class="text-muted">Total Services Used</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <h5 class="text-muted">Services Performance</h5>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card service-card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="service-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                <li><a class="dropdown-item" href="#">View Details</a></li>
                                <li><a class="dropdown-item" href="#">Export Data</a></li>
                            </ul>
                        </div>
                    </div>
                    <h6 class="card-title">Roads Department</h6>
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <h5 class="mb-0">23</h5>
                            <small class="text-muted">Complaints</small>
                        </div>
                        <div>
                            <h5 class="mb-0">1.2M</h5>
                            <small class="text-muted">Population Served</small>
                        </div>
                        <div>
                            <h5 class="mb-0">65%</h5>
                            <small class="text-muted">Resolution Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card service-card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="service-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                                <li><a class="dropdown-item" href="#">View Details</a></li>
                                <li><a class="dropdown-item" href="#">Export Data</a></li>
                            </ul>
                        </div>
                    </div>
                    <h6 class="card-title">Water Department</h6>
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <h5 class="mb-0">11</h5>
                            <small class="text-muted">Complaints</small>
                        </div>
                        <div>
                            <h5 class="mb-0">800K</h5>
                            <small class="text-muted">Population Served</small>
                        </div>
                        <div>
                            <h5 class="mb-0">79%</h5>
                            <small class="text-muted">Resolution Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card service-card border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="service-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link" type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                                <li><a class="dropdown-item" href="#">View Details</a></li>
                                <li><a class="dropdown-item" href="#">Export Data</a></li>
                            </ul>
                        </div>
                    </div>
                    <h6 class="card-title">Electricity Department</h6>
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <h5 class="mb-0">28</h5>
                            <small class="text-muted">Complaints</small>
                        </div>
                        <div>
                            <h5 class="mb-0">1.2M</h5>
                            <small class="text-muted">Population Served</small>
                        </div>
                        <div>
                            <h5 class="mb-0">71%</h5>
                            <small class="text-muted">Resolution Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Monthly Complaints Chart
    var ctxMonthly = document.getElementById('monthlyComplaintsChart').getContext('2d');
    var monthlyComplaintsChart = new Chart(ctxMonthly, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Submitted',
                data: [65, 59, 80, 81, 56, 55, 40, 45, 50, 60, 70, 75],
                backgroundColor: 'rgba(78, 115, 223, 0.8)',
                borderWidth: 0,
                borderRadius: 4
            }, {
                label: 'Resolved',
                data: [45, 49, 60, 71, 46, 45, 30, 35, 40, 50, 60, 65],
                backgroundColor: 'rgba(28, 200, 138, 0.8)',
                borderWidth: 0,
                borderRadius: 4
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    align: 'end'
                }
            }
        }
    });
    
    var ctxStatus = document.getElementById('statusChart').getContext('2d');
    var statusChart = new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Submitted', 'Under Review', 'In Progress', 'Resolved', 'Closed'],
            datasets: [{
                data: [15, 20, 25, 30, 10],
                backgroundColor: [
                    '#36b9cc',
                    '#6c757d',
                    '#4e73df',
                    '#1cc88a',
                    '#5a5c69'
                ],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    function createGaugeChart(ctx, percentage, color) {
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [percentage, 100 - percentage],
                    backgroundColor: [color, '#f1f1f1'],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                maintainAspectRatio: false,
                cutout: '80%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });
    }
    
    var ctxMostUsed = document.getElementById('mostUsedServiceChart').getContext('2d');
    var mostUsedServiceChart = createGaugeChart(ctxMostUsed, 78, '#4e73df');
    
    var ctxLeastUsed = document.getElementById('leastUsedServiceChart').getContext('2d');
    var leastUsedServiceChart = createGaugeChart(ctxLeastUsed, 12, '#e74a3b');
</script>
{% endblock %}